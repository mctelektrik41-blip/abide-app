<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ABIDE</title>
</head>

<style>
  body {
    background-color: #111;
    /* YumuÅŸak Siyah (Premium) */
    color: #eee;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    min-height: 100vh;
  }

  .container {
    width: 100%;
    max-width: 400px;
    /* Telefon boyutu simÃ¼lasyonu */
    background: #111;
    padding: 20px;
    box-sizing: border-box;
    padding-bottom: 80px;
    /* Reklam payÄ± */
  }

  /* Mikrofon animasyonu */
  @keyframes pulse {
    0% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
    }

    70% {
      transform: scale(1.1);
      box-shadow: 0 0 0 10px rgba(255, 0, 0, 0);
    }

    100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
    }
  }

  .recording {
    animation: pulse 1.5s infinite;
    background: #c00 !important;
    border: 1px solid #f00 !important;
  }
</style>
<div style="max-width:680px; margin:0 auto; padding:28px;">
  <h1 style="margin:0 0 10px 0;">ABIDE</h1>
  <p style="margin:0 0 22px 0; opacity:0.85;" id="subtitle">Gizli. YargÄ±sÄ±z. Sakin.</p>

  <!-- EKLENDÄ°: Dil + Mezhep seÃ§imi -->
  <div style="padding:16px; border:1px solid #333; border-radius:12px; margin-bottom:18px;">
    <div style="margin-bottom:8px; opacity:0.9;" id="setupTitle">BaÅŸlangÄ±Ã§</div>

    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px; align-items:center;">
      <label style="opacity:0.85;" id="langLabel">Dil:</label>
      <select id="lang" onchange="applyLang()"
        style="padding:8px 10px; border-radius:10px; border:1px solid #444; background:#0b0b0b; color:#fff;">
        <option value="tr" selected>TÃ¼rkÃ§e</option>
        <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        <option value="en">English</option>
      </select>

      <label style="opacity:0.85;" id="relLabel">Din:</label>
      <select id="religion" onchange="applyReligion()"
        style="padding:8px 10px; border-radius:10px; border:1px solid #444; background:#0b0b0b; color:#fff;">
        <option value="islam">Ä°slam</option>
        <option value="christianity">HristiyanlÄ±k</option>
        <option value="judaism">Yahudilik</option>
        <option value="buddhism">Budizm</option>
        <option value="spiritual">SpiritÃ¼el / Deist</option>
      </select>
    </div>

    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px; align-items:center;" id="denomContainer">
      <label style="opacity:0.85; min-width:80px;" id="denomLabel">Mezhep/Yol:</label>
      <select id="denom" onchange="applyDenom()"
        style="flex:1; min-width:150px; padding:8px 10px; border-radius:10px; border:1px solid #444; background:#0b0b0b; color:#fff;">
        <!-- Dinamik dolacak -->
      </select>
    </div>

    <div style="margin-bottom:12px;">
      <span style="opacity:0.7; margin-right:10px;" id="genderLabel">Cinsiyet:</span>
      <select id="gender" onchange="applyGender()"
        style="padding:8px 10px; border-radius:10px; border:1px solid #444; background:#0b0b0b; color:#fff;">
        <option value="male" selected>Erkek</option>
        <option value="female">KadÄ±n</option>
      </select>
    </div>

    <div id="setupHint" style="opacity:0.7; font-size:12px; margin-bottom:12px;">
      Bu seÃ§imler seni sÄ±nÄ±flandÄ±rmaz; yalnÄ±zca ton ve metin dilini ayarlar.
    </div>



    <!-- PREMIUM ALANI -->
    <div style="border-top:1px solid #444; margin-top:12px; padding-top:12px; text-align:center;">
      <button onclick="buyPremium()" id="btnPremium"
        style="background:linear-gradient(45deg, #FFD700, #FFA500); color:#000; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; cursor:pointer; width:100%;">
        ğŸ‘‘ ReklamlarÄ± KaldÄ±r (30 TL)
      </button>
      <div id="premiumStatus" style="font-size:12px; color:#4CAF50; display:none; margin-top:5px;">
        âœ“ Premium Ãœye (Reklamlar Gizlendi)
      </div>
    </div>
  </div>
  <!-- /EKLENDÄ° -->

  <!-- ESKÄ° SES PLAYERLARI KALDIRILDI -->

  <div style="padding:16px; border:1px solid #333; border-radius:12px; margin-bottom:18px;">
    <div style="margin-bottom:8px; opacity:0.9;" id="feelTitle">NasÄ±l hissediyorsun?</div>

    <div style="display:flex; flex-wrap:wrap; gap:10px;">
      <button onclick="triggerAI('tired')"
        style="padding:10px 14px; border-radius:10px; border:1px solid #444; background:#111; color:#fff; cursor:pointer;"
        id="btnTired">Yorgun</button>
      <button onclick="triggerAI('fear')"
        style="padding:10px 14px; border-radius:10px; border:1px solid #444; background:#111; color:#fff; cursor:pointer;"
        id="btnFear">KorkmuÅŸ</button>
      <button onclick="triggerAI('lonely')"
        style="padding:10px 14px; border-radius:10px; border:1px solid #444; background:#111; color:#fff; cursor:pointer;"
        id="btnAlone">YalnÄ±z</button>
      <button onclick="triggerAI('guilt')"
        style="padding:10px 14px; border-radius:10px; border:1px solid #444; background:#111; color:#fff; cursor:pointer;"
        id="btnGuilt">SuÃ§luluk</button>
    </div>

    <div style="margin-top:10px; opacity:0.7; font-size:12px;" id="feelNote">
      <!-- Not metni i18n'den gelecek -->
    </div>
  </div>

  <div style="padding:16px; border:1px solid #333; border-radius:12px; margin-bottom:18px;">
    <div style="margin-bottom:8px; opacity:0.9;" id="replyTitle">ABIDE yanÄ±tÄ±</div>
    <div id="responseBox"
      style="padding:12px; border-radius:10px; border:1px solid #444; background:#0b0b0b; min-height:48px; opacity:0.95;">
      Buraya yazdÄ±klarÄ±ndan bir duygu seÃ§ilecek ve uygun teselli sesi Ã§alacak.
    </div>

    <!-- REKLAM DUVARI (LÄ°MÄ°T DOLUNCA Ã‡IKAR) -->
    <div id="adWall"
      style="display:none; flex-direction:column; align-items:center; justify-content:center; margin-top:10px; padding:15px; background:#220; border:1px solid #dd0; border-radius:10px;">
      <div style="font-size:14px; color:#fff; margin-bottom:10px;">ğŸ”’ GÃ¼nlÃ¼k Limit Doldu</div>
      <button id="btnWatchAd" onclick="watchAd()"
        style="background:#f44336; color:white; padding:10px 20px; border:none; border-radius:20px; font-weight:bold; cursor:pointer; margin-top:8px;">
        ğŸ“º ReklamÄ± Ä°zle (+3 Hak)
      </button>
    </div>
  </div>

  <div style="padding:16px; border:1px solid #333; border-radius:12px; margin-bottom:18px;">
    <div style="margin-bottom:8px; opacity:0.9;" id="writeTitle">Ä°stersen yaz (kaydedilmez)</div>
    <div style="position:relative; display:flex; gap:8px; align-items:flex-end;">
      <textarea id="note" rows="2" placeholder="Buraya yazabilirsin..."
        style="flex:1; width:100%; padding:12px; border-radius:12px; border:1px solid #444; background:#1a1a1a; color:#fff; font-family:inherit; resize:none;"></textarea>

      <button id="btnMic" onclick="toggleRecord()"
        style="width:44px; height:44px; border-radius:50%; border:1px solid #444; background:#222; color:#fff; cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center;">
        ğŸ¤
      </button>
    </div>

    <div style="display:flex; justify-content:space-between; margin-top:10px;">
      <button onclick="submitText()"
        style="padding:10px 24px; border-radius:20px; border:none; background:#eee; color:#000; font-weight:bold; cursor:pointer;"
        id="btnSend">GÃ¶nder</button>
      <button onclick="clearText()"
        style="padding:10px 16px; border-radius:20px; border:1px solid #555; background:transparent; color:#aaa; cursor:pointer;"
        id="btnClear">Sil</button>
    </div>
  </div>

  <p style="margin-top:18px; font-size:12px; opacity:0.65;" id="disclaimer">
    ABIDE bir dinÃ® kurum deÄŸildir. Bu iÃ§erikler kiÅŸisel rahatlama ve tefekkÃ¼r amaÃ§lÄ±dÄ±r.
  </p>

  <!-- REKLAM ALANI (Sabit Alt Banner) -->
  <div id="adBanner"
    style="position:fixed; bottom:0; left:0; width:100%; height:60px; background:#222; border-top:1px solid #444; display:flex; align-items:center; justify-content:center; z-index:999;">
    <div style="color:#888; font-size:12px;">Google Ads AlanÄ± (Reklamlar Burada GÃ¶rÃ¼necek)</div>
    <!-- GerÃ§ekte buraya AdSense/AdMob kodu gelir -->
  </div>
  <div style="height:70px;"></div> <!-- Alt boÅŸluk -->
</div>

<script>
  // --- AYARLAR VE SABÄ°TLER ---
  const EMBEDDED_KEY = "AIzaSyDYaNiOgtuPX8erP-7lgngb2howl-pIwlk";

  var state = {
    lang: "tr",
    religion: "islam",
    denom: "sunni",
    gender: "male",
    premium: false,
    dailyCount: 0,
    lastVisit: new Date().toDateString()
  };

  // Din ve Mezhep VeritabanÄ±
  const RELIGIONS = {
    islam: {
      label: { tr: "Ä°slam", ru: "Ğ˜ÑĞ»Ğ°Ğ¼", en: "Islam" },
      denoms: {
        sunni: { tr: "SÃ¼nni", ru: "Ğ¡ÑƒĞ½Ğ½Ğ¸Ğ·Ğ¼", en: "Sunni" },
        shia: { tr: "Åii", ru: "Ğ¨Ğ¸Ğ¸Ğ·Ğ¼", en: "Shia" },
        sufi: { tr: "Tasavvuf / Sufi", ru: "Ğ¡ÑƒÑ„Ğ¸Ğ·Ğ¼", en: "Sufi" },
        general: { tr: "Mezhep yok / Farketmez", ru: "Ğ‘ĞµĞ· Ğ¼Ğ°Ğ·Ñ…Ğ°Ğ±Ğ°", en: "No Denom" }
      }
    },
    christianity: {
      label: { tr: "HristiyanlÄ±k", ru: "Ğ¥Ñ€Ğ¸ÑÑ‚Ğ¸Ğ°Ğ½ÑÑ‚Ğ²Ğ¾", en: "Christianity" },
      denoms: {
        orthodox: { tr: "Ortodoks", ru: "ĞŸÑ€Ğ°Ğ²Ğ¾ÑĞ»Ğ°Ğ²Ğ¸Ğµ", en: "Orthodox" },
        catholic: { tr: "Katolik", ru: "ĞšĞ°Ñ‚Ğ¾Ğ»Ğ¸Ñ†Ğ¸Ğ·Ğ¼", en: "Catholic" },
        protestant: { tr: "Protestan", ru: "ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ°Ğ½Ñ‚Ğ¸Ğ·Ğ¼", en: "Protestant" }
      }
    },
    judaism: {
      label: { tr: "Yahudilik", ru: "Ğ˜ÑƒĞ´Ğ°Ğ¸Ğ·Ğ¼", en: "Judaism" },
      denoms: {
        orthodox: { tr: "Ortodoks", ru: "ĞÑ€Ñ‚Ğ¾Ğ´Ğ¾ĞºÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹", en: "Orthodox" },
        reform: { tr: "Reformist", ru: "Ğ ĞµÑ„Ğ¾Ñ€Ğ¼Ğ¸ÑÑ‚ÑĞºĞ¸Ğ¹", en: "Reform" },
        kabbalah: { tr: "Kabbala", ru: "ĞšĞ°Ğ±Ğ±Ğ°Ğ»Ğ°", en: "Kabbalah" }
      }
    },
    buddhism: {
      label: { tr: "Budizm", ru: "Ğ‘ÑƒĞ´Ğ´Ğ¸Ğ·Ğ¼", en: "Buddhism" },
      denoms: {
        zen: { tr: "Zen", ru: "Ğ”Ğ·ĞµĞ½", en: "Zen" },
        tibetan: { tr: "Tibet", ru: "Ğ¢Ğ¸Ğ±ĞµÑ‚ÑĞºĞ¸Ğ¹", en: "Tibetan" }
      }
    },
    spiritual: {
      label: { tr: "Sadece YaratÄ±cÄ± / Deist", ru: "Ğ”ÑƒÑ…Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ", en: "Spiritual/Creator" },
      denoms: null // Alt seÃ§enek yok
    }
  };

  // Sohbet HafÄ±zasÄ± (AI'nÄ±n Ã¶nceki konuÅŸmalarÄ± hatÄ±rlamasÄ± iÃ§in)
  var chatHistory = [];

  // Metinler
  var I18N = {
    tr: {
      subtitle: "Gizli. YargÄ±sÄ±z. Sakin.",
      setupTitle: "BaÅŸlangÄ±Ã§",
      langLabel: "Dil:",
      relLabel: "Din:",
      denomLabel: "Mezhep/Yol:",
      genderLabel: "Cinsiyet:",
      setupHint: "Bu seÃ§imler Abide'nin sana nasÄ±l hitap edeceÄŸini belirler.",
      welcomeTitle: "KarÅŸÄ±lama",
      verseTitle: "Teselli Ayeti (Ã–rnek)",
      feelTitle: "NasÄ±l hissediyorsun?",
      btnTired: "Yorgun",
      btnFear: "KorkmuÅŸ",
      btnAlone: "YalnÄ±z",
      btnGuilt: "SuÃ§luluk",
      feelNote: "Rahat hissetmen ve teselli bulman dileÄŸiyle.",
      replyTitle: "ABIDE yanÄ±tÄ±",
      responseDefault: "Buraya yazdÄ±klarÄ±ndan bir duygu seÃ§ilecek ve uygun teselli sesi Ã§alacak.",
      writeTitle: "Ä°stersen yaz (kaydedilmez)",
      placeholder: "Buraya yazabilirsin...",
      btnSend: "GÃ¶nder",
      btnClear: "Sil",
      saveNote: "Not: Bu sayfa kaydetmez; tarayÄ±cÄ±yÄ± kapatÄ±nca unut.",
      disclaimer: "ABIDE bir dinÃ® kurum deÄŸildir. Bu iÃ§erikler kiÅŸisel rahatlama ve tefekkÃ¼r amaÃ§lÄ±dÄ±r.",
      msgCleared: "Metin silindi. Ä°stersen yeniden yazabilirsin.",
      msgNoText: "Bir ÅŸey yazmadÄ±n. Ä°stersen birkaÃ§ cÃ¼mle yaz ve GÃ¶nder'e bas.",
      msgPlaying: (tag) => "SeÃ§ilen duygu: " + tag + ". Åimdi kÄ±sa bir teselli dinle.",
      msgAuto: (tag) => "Seni anlÄ±yorum. Åu an '" + tag + "' hissi baskÄ±n gÃ¶rÃ¼nÃ¼yor. Birlikte kÄ±sa bir teselli dinleyelim."
    },
    ru: {
      subtitle: "Ğ¢Ğ°Ğ¹Ğ½Ğ¾. Ğ‘ĞµĞ· Ğ¾ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ñ. Ğ¡Ğ¿Ğ¾ĞºĞ¾Ğ¹Ğ½Ğ¾.",
      setupTitle: "Ğ¡Ñ‚Ğ°Ñ€Ñ‚",
      langLabel: "Ğ¯Ğ·Ñ‹Ğº:",
      relLabel: "Ğ ĞµĞ»Ğ¸Ğ³Ğ¸Ñ:",
      denomLabel: "Ğ¢Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸Ñ:",
      genderLabel: "ĞŸĞ¾Ğ»:",
      setupHint: "Ğ­Ñ‚Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ñ‹ Ğ½Ğµ ĞºĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒÑÑ‚ Ñ‚ĞµĞ±Ñ; Ğ¾Ğ½Ğ¸ Ğ»Ğ¸ÑˆÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ÑÑ‚ ÑĞ·Ñ‹Ğº Ğ¸ Ñ‚Ğ¾Ğ½.",
      welcomeTitle: "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ",
      verseTitle: "Ğ£Ñ‚ĞµÑˆĞµĞ½Ğ¸Ğµ (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€)",
      feelTitle: "Ğ§Ñ‚Ğ¾ Ñ‚Ñ‹ Ñ‡ÑƒĞ²ÑÑ‚Ğ²ÑƒĞµÑˆÑŒ?",
      btnTired: "Ğ£ÑÑ‚Ğ°Ğ»Ğ¾ÑÑ‚ÑŒ",
      btnFear: "Ğ¡Ñ‚Ñ€Ğ°Ñ…",
      btnAlone: "ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞµÑÑ‚Ğ²Ğ¾",
      btnGuilt: "Ğ’Ğ¸Ğ½Ğ°",
      feelNote: "ĞŸÑƒÑÑ‚ÑŒ ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¸Ğ½ĞµÑĞµÑ‚ Ñ‚ĞµĞ±Ğµ Ğ¼Ğ¸Ñ€ Ğ¸ ÑƒÑ‚ĞµÑˆĞµĞ½Ğ¸Ğµ.",
      replyTitle: "ĞÑ‚Ğ²ĞµÑ‚ ABIDE",
      responseDefault: "ABIDE Ğ²Ñ‹Ğ±ĞµÑ€ĞµÑ‚ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ Ñ‚Ğ²Ğ¾ĞµĞ¼Ñƒ Ñ‚ĞµĞºÑÑ‚Ñƒ Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ³Ñ€Ğ°ĞµÑ‚ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ ÑƒÑ‚ĞµÑˆĞµĞ½Ğ¸Ğµ.",
      writeTitle: "ĞœĞ¾Ğ¶ĞµÑˆÑŒ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ (Ğ½Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ)",
      placeholder: "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ·Ğ´ĞµÑÑŒ...",
      btnSend: "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ",
      btnClear: "ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ",
      saveNote: "ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ: ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚.",
      disclaimer: "ABIDE Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ñ€ĞµĞ»Ğ¸Ğ³Ğ¸Ğ¾Ğ·Ğ½Ñ‹Ğ¼ ÑƒÑ‡Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸ĞµĞ¼. ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ğ¿Ñ€ĞµĞ´Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ Ğ´Ğ»Ñ Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ÑƒÑĞ¿Ğ¾ĞºĞ¾ĞµĞ½Ğ¸Ñ Ğ¸ Ñ€Ğ°Ğ·Ğ¼Ñ‹ÑˆĞ»ĞµĞ½Ğ¸Ñ.",
      msgCleared: "Ğ¢ĞµĞºÑÑ‚ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½. ĞœĞ¾Ğ¶ĞµÑˆÑŒ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.",
      msgNoText: "Ğ¢Ñ‹ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ». ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¿Ğ°Ñ€Ñƒ Ñ„Ñ€Ğ°Ğ· Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Â«ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒÂ».",
      msgPlaying: (tag) => "Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾: " + tag + ". Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ğ¾ÑĞ»ÑƒÑˆĞ°ĞµĞ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ ÑƒÑ‚ĞµÑˆĞµĞ½Ğ¸Ğµ.",
      msgAuto: (tag) => "Ğ¯ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ñ. ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ¿Ñ€ĞµĞ¾Ğ±Ğ»Ğ°Ğ´Ğ°ĞµÑ‚ '" + tag + "'. Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ğ¾ÑĞ»ÑƒÑˆĞ°ĞµĞ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ ÑƒÑ‚ĞµÑˆĞµĞ½Ğ¸Ğµ."
    },
    en: {
      subtitle: "Private. Judgment-free. Calm.",
      setupTitle: "Start",
      langLabel: "Language:",
      relLabel: "Religion:",
      denomLabel: "Denom/Path:",
      genderLabel: "Gender:",
      setupHint: "These choices do not classify you; they only set language and tone.",
      welcomeTitle: "Welcome",
      verseTitle: "Comfort (sample)",
      feelTitle: "How do you feel?",
      btnTired: "Tired",
      btnFear: "Fear",
      btnAlone: "Lonely",
      btnGuilt: "Guilt",
      feelNote: "Note: Some specific audios are missing for English, playing general comfort instead.",
      replyTitle: "ABIDE reply",
      responseDefault: "ABIDE will pick a feeling from your text and play a short comfort.",
      writeTitle: "Write if you want (not saved)",
      placeholder: "Write here...",
      btnSend: "Send",
      btnClear: "Clear",
      saveNote: "Note: this page saves nothing.",
      disclaimer: "ABIDE is not a religious institution. This content is for personal comfort and reflection.",
      msgCleared: "Text cleared. You can write again.",
      msgNoText: "You wrote nothing. Write a few lines and press Send.",
      msgPlaying: (tag) => "Selected feeling: " + tag + ". Now listen to a short comfort.",
      msgAuto: (tag) => "I hear you. It seems '" + tag + "' is dominant right now. Let's listen to a short comfort."
    }
  };

  // --- ESKÄ° SES FONKSÄ°YONLARI SÄ°LÄ°NDÄ° ---

  function applyLang() {
    state.lang = document.getElementById('lang').value;
    renderI18n();
    renderI18n();
    updateReligionsUI();
  }

  // ArayÃ¼zdeki Din/Mezhep listesini gÃ¼ncelleme
  function updateReligionsUI() {
    // 1. Din Listesini Doldur (Sadece etiketleri gÃ¼ncelle)
    // Basitlik iÃ§in statik HTML kullandÄ±k ama etiketleri JS ile gÃ¼ncelleyebiliriz.
    // Åimdilik sadece Mezhep listesini yeniden oluÅŸturacaÄŸÄ±z.

    var rel = state.religion;
    var rData = RELIGIONS[rel];
    var dSelect = document.getElementById("denom");

    dSelect.innerHTML = ""; // Temizle

    if (rData && rData.denoms) {
      document.getElementById("denomContainer").style.display = "flex";
      // SeÃ§enekleri ekle
      for (var key in rData.denoms) {
        var opt = document.createElement("option");
        opt.value = key;
        opt.textContent = rData.denoms[key][state.lang];
        if (key === state.denom) opt.selected = true;
        dSelect.appendChild(opt);
      }
      // EÄŸer mevcut seÃ§im listede yoksa ilkini seÃ§
      if (!rData.denoms[state.denom]) {
        state.denom = Object.keys(rData.denoms)[0];
        dSelect.value = state.denom;
      }
    } else {
      // Alt mezhep yoksa gizle
      document.getElementById("denomContainer").style.display = "none";
      state.denom = "general";
    }
  }

  function applyReligion() {
    state.religion = document.getElementById("religion").value;
    updateReligionsUI();
    setResponse("Din gÃ¼ncellendi. Mezhep seÃ§enekleri deÄŸiÅŸti.");
    chatHistory = [];
  }

  function applyDenom() {
    state.denom = document.getElementById('denom').value;
    setResponse("Mezhep ayarlandÄ±.");
    chatHistory = []; // Yeni ayar, yeni sayfa
  }

  function applyGender() {
    state.gender = document.getElementById('gender').value;
    setResponse("Cinsiyet ayarlandÄ±. Sohbet hafÄ±zasÄ± temizlendi.");
    chatHistory = [];
  }

  function renderI18n() {
    var t = I18N[state.lang];
    document.getElementById('subtitle').textContent = t.subtitle;
    document.getElementById('setupTitle').textContent = t.setupTitle;
    document.getElementById('langLabel').textContent = t.langLabel;
    if (document.getElementById('relLabel')) document.getElementById('relLabel').textContent = t.relLabel || "Din:";
    document.getElementById('denomLabel').textContent = t.denomLabel;
    if (document.getElementById('genderLabel')) document.getElementById('genderLabel').textContent = t.genderLabel || "Cinsiyet:";
    document.getElementById('setupHint').textContent = t.setupHint;
    // document.getElementById('welcomeTitle').textContent = t.welcomeTitle; // Silindi
    // document.getElementById('verseTitle').textContent = t.verseTitle;   // Silindi
    document.getElementById('feelTitle').textContent = t.feelTitle;
    document.getElementById('btnTired').textContent = t.btnTired;
    document.getElementById('btnFear').textContent = t.btnFear;
    document.getElementById('btnAlone').textContent = t.btnAlone;
    document.getElementById('btnGuilt').textContent = t.btnGuilt;
    document.getElementById('feelNote').textContent = t.feelNote;
    document.getElementById('replyTitle').textContent = t.replyTitle;
    document.getElementById('writeTitle').textContent = t.writeTitle;
    document.getElementById('btnSend').textContent = t.btnSend;
    document.getElementById('btnClear').textContent = t.btnClear;
    document.getElementById('saveNote').textContent = t.saveNote;
    document.getElementById('disclaimer').textContent = t.disclaimer;
    document.getElementById('note').placeholder = t.placeholder;
  }

  function setResponse(msg) {
    document.getElementById('responseBox').textContent = msg;
  }

  function clearNote() {
    document.getElementById('note').value = '';
    setResponse(I18N[state.lang].msgCleared);
  }

  // Butonlara basÄ±lÄ±nca MP3 DEÄÄ°L, direkt AI Ã§alÄ±ÅŸsÄ±n
  async function triggerAI(tag) {
    // Tag'e gÃ¶re bir metin uyduralÄ±m
    var map = {
      'tired': { tr: "Kendimi Ã§ok yorgun ve bitkin hissediyorum. Ruhum daraldÄ±.", ru: "Ğ¯ Ñ‚Ğ°Ğº ÑƒÑÑ‚Ğ°Ğ».", en: "I feel very tired." },
      'fear': { tr: "Ä°Ã§imde bir korku ve endiÅŸe var. Huzursuzum.", ru: "ĞœĞ½Ğµ ÑÑ‚Ñ€Ğ°ÑˆĞ½Ğ¾.", en: "I feel fear." },
      'lonely': { tr: "Kendimi Ã§ok yalnÄ±z ve kimsesiz hissediyorum.", ru: "ĞœĞ½Ğµ Ğ¾Ğ´Ğ¸Ğ½Ğ¾ĞºĞ¾.", en: "I feel lonely." },
      'guilt': { tr: "Vicdan azabÄ± Ã§ekiyorum, suÃ§luluk hissediyorum.", ru: "Ğ¯ Ñ‡ÑƒĞ²ÑÑ‚Ğ²ÑƒÑ Ğ²Ğ¸Ğ½Ñƒ.", en: "I feel guilt." }
    };

    var userText = map[tag][state.lang];
    document.getElementById('note').value = userText; // Kutuya yaz

    setResponse("Abide dÃ¼ÅŸÃ¼nÃ¼yor... (" + tag + ")");
    // AI Ã‡aÄŸÄ±r
    var aiResponse = await callHuggingFaceAI(userText, tag);
    if (aiResponse) {
      setResponse(aiResponse);
      speakResponse(aiResponse);
    }
  }

  // Basit anahtar kelime yakalama (v1) -> STANDART ETIKETLER DONER
  function detectTag(text) {
    var t = (text || "").toLowerCase();

    // TÃ¼rkÃ§e
    if (state.lang === "tr") {
      if (t.includes("bunald") || t.includes("yapamÄ±yor") || t.includes("baÅŸ edem") || t.includes("dayanam") || t.includes("yoruld")) return "tired";
      if (t.includes("kork") || t.includes("endiÅŸ") || t.includes("panik")) return "fear";
      if (t.includes("yalnÄ±z") || t.includes("kimsem yok") || t.includes("terk")) return "lonely";
      if (t.includes("suÃ§") || t.includes("piÅŸman") || t.includes("utanÃ§") || t.includes("gÃ¼nah")) return "guilt";
      if (t.includes("iliÅŸki") || t.includes("Ã§ocuk") || t.includes("babal") || t.includes("hamile") || t.includes("doÄŸurdu")) return "tired";
      return "tired"; // VarsayÄ±lan
    }

    // RusÃ§a
    if (state.lang === "ru") {
      if (t.includes("ÑƒÑÑ‚Ğ°Ğ»") || t.includes("Ğ½Ğµ Ğ¼Ğ¾Ğ³Ñƒ") || t.includes("Ñ‚ÑĞ¶ĞµĞ»Ğ¾") || t.includes("Ğ²Ñ‹Ğ³Ğ¾Ñ€ĞµĞ»")) return "tired";
      if (t.includes("ÑÑ‚Ñ€Ğ°Ñ…") || t.includes("Ğ±Ğ¾ÑÑ") || t.includes("Ñ‚Ñ€ĞµĞ²Ğ¾Ğ³") || t.includes("Ğ¿Ğ°Ğ½Ğ¸Ğº")) return "fear";
      if (t.includes("Ğ¾Ğ´Ğ¸Ğ½") || t.includes("Ğ¾Ğ´Ğ¸Ğ½Ğ¾") || t.includes("Ğ½Ğ¸ĞºĞ¾Ğ³Ğ¾ Ğ½ĞµÑ‚")) return "lonely";
      if (t.includes("Ğ²Ğ¸Ğ½Ğ°") || t.includes("ÑÑ‚Ñ‹Ğ´") || t.includes("Ğ³Ñ€ĞµÑ…")) return "guilt";
      return "tired";
    }

    // Ä°ngilizce
    if (t.includes("tired") || t.includes("can't") || t.includes("exhaust")) return "tired";
    if (t.includes("fear") || t.includes("anx") || t.includes("panic")) return "fear";
    if (t.includes("alone") || t.includes("lonely")) return "lonely";
    if (t.includes("guilt") || t.includes("shame") || t.includes("sin")) return "guilt";
    return "tired";
  }

  // --- YENÄ°: AI Ä°ÅLEMLERÄ° ---
  function loadApiKey() {
    // Premium kontrolÃ¼
    var isPrem = localStorage.getItem("abide_premium");
    if (isPrem === "true") {
      state.premium = true;
      updatePremiumUI();
    }
  }

  function buyPremium() {
    // BURAYA SHOPIER LINKI GELECEK
    var confirmBuy = confirm("ReklamlarÄ± kaldÄ±rmak iÃ§in 30 TL Ã¶deme sayfasÄ±na yÃ¶nlendiriliyorsunuz. (SimÃ¼lasyon: Tamam derseniz satÄ±n alÄ±nmÄ±ÅŸ sayÄ±lacak)");
    if (confirmBuy) {
      localStorage.setItem("abide_premium", "true");
      state.premium = true;
      updatePremiumUI();
      alert("TeÅŸekkÃ¼rler! Premium Ã¶zellikler aÃ§Ä±ldÄ±.");
    }
  }

  function updatePremiumUI() {
    if (state.premium) {
      document.getElementById('adBanner').style.display = 'none'; // ReklamÄ± gizle
      document.getElementById('btnPremium').style.display = 'none'; // Butonu gizle
      document.getElementById('premiumStatus').style.display = 'block'; // StatÃ¼yÃ¼ gÃ¶ster
    }
  }

  // --- SESLÄ° GÄ°RÄ°Å (Speech-to-Text) ---
  var recognition;
  var isRecording = false;

  // Sayfa yÃ¼klenince (veya ilk ihtiyaÃ§ta) recognition nesnesini hazÄ±rla
  function setupRecognition() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      if (document.getElementById("btnMic")) document.getElementById("btnMic").style.display = "none";
      return null;
    }
    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    var rec = new SpeechRecognition();

    // SÃœREKLÄ° DÄ°NLEME: KullanÄ±cÄ± dur diyene kadar kapanmaz
    rec.continuous = true;
    rec.interimResults = false; // TEKRARI Ã–NLEMEK Ä°Ã‡Ä°N: Sadece kesinleÅŸince yazsÄ±n

    rec.onstart = function () {
      isRecording = true;
      document.getElementById("btnMic").classList.add("recording");
    };

    // Otomatik kapanÄ±rsa (sessizlik vs) ve biz durdurmadÄ±ysak
    rec.onend = function () {
      // EÄŸer kullanÄ±cÄ± butona basÄ±p durdurmadÄ±ysa, tarayÄ±cÄ± kendi kapattÄ± demektir.
      // Tekrar baÅŸlatmak yerine kullanÄ±cÄ±ya bÄ±rakÄ±yoruz (SÃ¼rekli izin istemesin diye).
      isRecording = false;
      document.getElementById("btnMic").classList.remove("recording");
    };

    rec.onresult = function (event) {
      // Sadece en son gelen sonucu alalÄ±m
      var lastIndex = event.results.length - 1;
      var transcript = event.results[lastIndex][0].transcript;

      // BoÅŸ deÄŸilse ekle
      if (transcript) {
        var note = document.getElementById("note");
        // Ã–nceki metin varsa boÅŸluk bÄ±rakÄ±p ekle
        note.value = note.value ? (note.value.trim() + " " + transcript) : transcript;
      }
    };

    rec.onerror = function (event) {
      console.error("Speech error", event.error);
      // Hata olunca dur
      isRecording = false;
      if (document.getElementById("btnMic")) document.getElementById("btnMic").classList.remove("recording");
    };

    return rec;
  }

  function toggleRecord() {
    if (!recognition) {
      recognition = setupRecognition();
      if (!recognition) return;
    }

    if (isRecording) {
      recognition.stop();
      isRecording = false; // Manuel durdurma
    } else {
      // Dili ayarla
      var langMap = { 'tr': 'tr-TR', 'en': 'en-US', 'ru': 'ru-RU' };
      recognition.lang = langMap[state.lang] || 'tr-TR';
      recognition.start();
    }
  }

  // Ä°lk kurulum
  setTimeout(function () {
    recognition = setupRecognition();
  }, 1000);



  function checkDailyLimit() {
    if (state.premium) return true;
    var today = new Date().toDateString();
    if (state.lastVisit !== today) {
      state.dailyCount = 0;
      state.lastVisit = today;
      localStorage.setItem("abide_last_visit", today);
      localStorage.setItem("abide_daily_count", "0");
    }
    if (state.dailyCount >= 3) {
      showLimitWarning();
      return false;
    }
    return true;
  }

  function incrementUsage() {
    if (state.premium) return;
    state.dailyCount++;
    localStorage.setItem("abide_daily_count", state.dailyCount);
  }

  function showLimitWarning() {
    var txt = {
      tr: "BugÃ¼nkÃ¼ 3 Ã¼cretsiz soru hakkÄ±n doldu. Devam etmek iÃ§in kÄ±sa bir reklam izlemelisin.",
      ru: "Ğ’Ğ°ÑˆĞ¸ 3 Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ñ… Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ° Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ğ°Ğ½Ñ‹. ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚Ğµ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ.",
      en: "You used your 3 free questions for today. Watch an ad to continue."
    };
    setResponse(txt[state.lang]);
    document.getElementById("adWall").style.display = "flex";
  }

  function watchAd() {
    var btn = document.getElementById("btnWatchAd");
    btn.innerHTML = "Reklam YÃ¼kleniyor...";
    btn.disabled = true;
    setTimeout(function () {
      alert("TeÅŸekkÃ¼rler! +3 Soru HakkÄ± KazandÄ±n.");
      state.dailyCount = 0;
      localStorage.setItem("abide_daily_count", "0");
      document.getElementById("adWall").style.display = "none";
      btn.innerHTML = "ğŸ“º ReklamÄ± Ä°zle (+3 Hak)";
      btn.disabled = false;
      setResponse("Harika! KaldÄ±ÄŸÄ±mÄ±z yerden devam edelim. Dinliyorum...");
    }, 2000);
  }

  async function callHuggingFaceAI(userText, detectedTag) {
    if (!checkDailyLimit()) return null;

    var apiKey = localStorage.getItem("abide_api_key");
    if (!apiKey || apiKey.trim() === "") apiKey = EMBEDDED_KEY;
    if (!apiKey) {
      setResponse("Hata: Token bulunamadÄ±.");
      return null;
    }
    apiKey = apiKey.trim();

    // API Tipi Belirleme (Google vs HuggingFace)
    var isGoogle = apiKey.startsWith("AIza");
    var apiUrl = isGoogle
      ? "https://generativelanguage.googleapis.com/v1beta/openai/chat/completions"
      : "https://router.huggingface.co/v1/chat/completions";

    var modelName = isGoogle ? "gemini-1.5-flash" : "google/gemma-2-9b-it";

    // ... Prompt ve Mesaj HazÄ±rlÄ±ÄŸÄ± ...
    var langName = state.lang === "tr" ? "TÃ¼rkÃ§e" : (state.lang === "ru" ? "RusÃ§a" : "Ä°ngilizce");
    var genderName = state.gender === "male" ? "Erkek" : "KadÄ±n";
    var rData = RELIGIONS[state.religion];
    var rLabel = rData.label[state.lang];
    var dLabel = (rData.denoms && rData.denoms[state.denom]) ? rData.denoms[state.denom][state.lang] : "";
    var fullFaith = rLabel + (dLabel ? " (" + dLabel + ")" : "");
    var hitap = (state.lang === "tr") ? (state.gender === "male" ? "Beyefendi/OÄŸlum/KardeÅŸim" : "HanÄ±mefendi/KÄ±zÄ±m/KardeÅŸim") : (state.lang === "ru" ? (state.gender === "male" ? "Ğ“Ğ¾ÑĞ¿Ğ¾Ğ´Ğ¸Ğ½/SÄ±n/Brat" : "Gospoga/Doch/Sestra") : (state.gender === "male" ? "Sir/Son/Brother" : "Madam/Daughter/Sister"));

    var systemInstruction = `Sen 'Abide' adÄ±nda, bilge, ÅŸefkatli ve derin konuÅŸan bir manevi rehbersin.
      KULLANICI PROFÄ°LÄ°: Cinsiyet: ${genderName} (${hitap}), Ä°nanÃ§: ${fullFaith}, Dil: ${langName}.
      KURALLAR: 1. Yapay zeka gibi konuÅŸma. 2. Cevaplar kÄ±sa olsun. 3. Ä°nanca uygun terminoloji kullan. 4. CevabÄ± sadece ${langName} dilinde ver.`;

    var messages = [
      { role: "system", content: systemInstruction },
      ...chatHistory,
      { role: "user", content: userText }
    ];

    try {
      setResponse("Abide dÃ¼ÅŸÃ¼nÃ¼yor... (KiÅŸiselleÅŸtirilmiÅŸ)");
      var response = await fetch(apiUrl, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + apiKey,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: modelName,
          messages: messages,
          max_tokens: 500,
          temperature: 0.7
        })
      });

      if (!response.ok) {
        var errText = await response.text();
        throw new Error("HTTP " + response.status + ": " + errText);
      }

      var data = await response.json();

      if (data && data.choices && data.choices.length > 0) {
        // BaÅŸarÄ±lÄ± cevap geldi, sayacÄ± artÄ±r
        incrementUsage();
        var aiText = data.choices[0].message.content;

        // HAFIZAYA KAYDET
        chatHistory.push({ role: "user", content: userText }); // KullanÄ±cÄ±nÄ±n dediÄŸini hatÄ±rla
        chatHistory.push({ role: "assistant", content: aiText }); // Kendi cevabÄ±nÄ± hatÄ±rla

        // HafÄ±za Ã§ok ÅŸiÅŸmesin (Son 6 mesaj - 3 tur)
        if (chatHistory.length > 6) chatHistory = chatHistory.slice(-6);

        return aiText;
      } else if (data && data.error) {
        throw new Error(data.error);
      } else {
        throw new Error("BoÅŸ cevap dÃ¶ndÃ¼.");
      }

    } catch (error) {
      console.error("HF HatasÄ±:", error);
      return "âš ï¸ HATA: " + error.message;
    }
  }
  // --- TTS (Seslendirme) Ä°ÅLEMLERÄ° ---
  function speakResponse(text) {
    if (!window.speechSynthesis) return;

    // Varsa eskisini sustur
    window.speechSynthesis.cancel();

    // HTML taglerini ve markdown iÅŸaretlerini temizle
    var cleanText = text.replace(/<[^>]*>/g, "").replace(/\*/g, "");

    var u = new SpeechSynthesisUtterance(cleanText);
    // Dili state'den al
    var langMap = { "tr": "tr-TR", "ru": "ru-RU", "en": "en-US" };
    u.lang = langMap[state.lang] || "tr-TR";

    u.rate = 0.9; // Biraz yavaÅŸ ve sakin
    u.pitch = 1.0;

    window.speechSynthesis.speak(u);
  }
  // --- /AI ve TTS Ä°ÅLEMLERÄ° ---

  async function submitText() {
    var text = document.getElementById('note').value.trim();
    if (!text) {
      setResponse(I18N[state.lang].msgNoText);
      return;
    }

    var tag = detectTag(text);

    // var p = document.getElementById('versePlayer');
    // var file = pickVerseFile(tag);
    // setAudioSource(p, file);
    // try { p.currentTime = 0; } catch (e) { }
    // p.play();

    setResponse("Abide dÃ¼ÅŸÃ¼nÃ¼yor...");

    // Hugging Face fonksiyonunu Ã§aÄŸÄ±r
    var aiResponse = await callHuggingFaceAI(text, tag);
    if (aiResponse) {
      setResponse(aiResponse);
      speakResponse(aiResponse);
    }
  }

  // Ä°lk yÃ¼kleme
  loadApiKey();
  renderI18n();
  updateReligionsUI(); // Mezhep listesini doldur
  // syncAudioToLang(); // Silindi
  setResponse(I18N[state.lang].responseDefault);
</script>
</body>

</html>```
