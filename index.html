<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ABIDE</title>
</head>

<style>
  body {
    background-color: #111;
    color: #eee;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    min-height: 100vh;
  }

  .container {
    width: 100%;
    max-width: 400px;
    background: #111;
    padding: 20px;
    box-sizing: border-box;
    padding-bottom: 80px;
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
    }

    70% {
      transform: scale(1.1);
      box-shadow: 0 0 0 10px rgba(255, 0, 0, 0);
    }

    100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
    }
  }

  .recording {
    animation: pulse 1.5s infinite;
    background: #c00 !important;
    border: 1px solid #f00 !important;
  }
</style>

<div style="max-width:680px; margin:0 auto; padding:28px;">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h1 style="margin:0;">ABIDE</h1>
    <button id="toggleAudioBtn" onclick="toggleAudioInit()"
      style="background:#222; border:1px solid #444; color:#fff; padding:6px 12px; border-radius:15px; font-size:12px; cursor:pointer;">
      ğŸ”Š Ses KapalÄ±
    </button>
  </div>
  <p style="margin:5px 0 22px 0; opacity:0.85;" id="subtitle">Gizli. YargÄ±sÄ±z. Sakin.</p>

  <!-- BAÅLANGIÃ‡ AYARLARI -->
  <div style="padding:16px; border:1px solid #333; border-radius:12px; margin-bottom:18px;">
    <div style="margin-bottom:8px; opacity:0.9;" id="setupTitle">BaÅŸlangÄ±Ã§</div>

    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px; align-items:center;">
      <label style="opacity:0.85;" id="langLabel">Dil:</label>
      <select id="lang" onchange="applyLang()"
        style="padding:8px 10px; border-radius:10px; border:1px solid #444; background:#0b0b0b; color:#fff;">
        <option value="tr" selected>TÃ¼rkÃ§e</option>
        <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        <option value="en">English</option>
      </select>

      <label style="opacity:0.85;" id="relLabel">Din:</label>
      <select id="religion" onchange="applyReligion()"
        style="padding:8px 10px; border-radius:10px; border:1px solid #444; background:#0b0b0b; color:#fff;">
        <option value="islam">Ä°slam</option>
        <option value="christianity">HristiyanlÄ±k</option>
        <option value="judaism">Yahudilik</option>
        <option value="buddhism">Budizm</option>
        <option value="spiritual">SpiritÃ¼el / Deist</option>
      </select>
    </div>

    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px; align-items:center;" id="denomContainer">
      <label style="opacity:0.85; min-width:80px;" id="denomLabel">Mezhep/Yol:</label>
      <select id="denom" onchange="applyDenom()"
        style="flex:1; min-width:150px; padding:8px 10px; border-radius:10px; border:1px solid #444; background:#0b0b0b; color:#fff;">
      </select>
    </div>

    <div style="margin-bottom:12px;">
      <span style="opacity:0.7; margin-right:10px;" id="genderLabel">Cinsiyet:</span>
      <select id="gender" onchange="applyGender()"
        style="padding:8px 10px; border-radius:10px; border:1px solid #444; background:#0b0b0b; color:#fff;">
        <option value="male" selected>Erkek</option>
        <option value="female">KadÄ±n</option>
      </select>
    </div>

    <div id="setupHint" style="opacity:0.7; font-size:12px; margin-bottom:12px;">
      Bu seÃ§imler Abide'nin sana nasÄ±l hitap edeceÄŸini belirler.
    </div>

    <!-- PREMIUM ALANI -->
    <div style="border-top:1px solid #444; margin-top:12px; padding-top:12px; text-align:center;">
      <button onclick="buyPremium()" id="btnPremium"
        style="background:linear-gradient(45deg, #FFD700, #FFA500); color:#000; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; cursor:pointer; width:100%;">
        ğŸ‘‘ ReklamlarÄ± KaldÄ±r (30 TL)
      </button>
      <div id="premiumStatus" style="font-size:12px; color:#4CAF50; display:none; margin-top:5px;">
        âœ“ Premium Ãœye (Reklamlar Gizlendi)
      </div>
    </div>
  </div>

  <!-- DUYGU BUTONLARI -->
  <div style="padding:16px; border:1px solid #333; border-radius:12px; margin-bottom:18px;">
    <div style="margin-bottom:8px; opacity:0.9;" id="feelTitle">NasÄ±l hissediyorsun?</div>
    <div style="display:flex; flex-wrap:wrap; gap:10px;">
      <button onclick="triggerAI('tired')"
        style="padding:10px 14px; border-radius:10px; border:1px solid #444; background:#111; color:#fff; cursor:pointer;"
        id="btnTired">Yorgun</button>
      <button onclick="triggerAI('fear')"
        style="padding:10px 14px; border-radius:10px; border:1px solid #444; background:#111; color:#fff; cursor:pointer;"
        id="btnFear">KorkmuÅŸ</button>
      <button onclick="triggerAI('lonely')"
        style="padding:10px 14px; border-radius:10px; border:1px solid #444; background:#111; color:#fff; cursor:pointer;"
        id="btnAlone">YalnÄ±z</button>
      <button onclick="triggerAI('guilt')"
        style="padding:10px 14px; border-radius:10px; border:1px solid #444; background:#111; color:#fff; cursor:pointer;"
        id="btnGuilt">SuÃ§luluk</button>
    </div>
    <div style="margin-top:10px; opacity:0.7; font-size:12px;" id="feelNote"></div>
  </div>

  <!-- ABIDE YANITI -->
  <div style="padding:16px; border:1px solid #333; border-radius:12px; margin-bottom:18px;">
    <div style="margin-bottom:8px; opacity:0.9;" id="replyTitle">ABIDE yanÄ±tÄ±</div>
    <div id="responseBox"
      style="padding:12px; border-radius:10px; border:1px solid #444; background:#0b0b0b; min-height:48px; opacity:0.95;">
      YanÄ±t bekliyor...
    </div>
    <button id="btnSpeakAgain" onclick="manualSpeak()"
      style="display:none; margin-top:8px; background:transparent; border:1px solid #555; color:#eee; padding:5px 12px; border-radius:15px; font-size:12px; cursor:pointer;">
      ğŸ”Š Sesli Dinle
    </button>

    <!-- REKLAM DUVARI -->
    <div id="adWall"
      style="display:none; flex-direction:column; align-items:center; justify-content:center; margin-top:10px; padding:15px; background:#220; border:1px solid #dd0; border-radius:10px;">
      <div style="font-size:14px; color:#fff; margin-bottom:10px;">ğŸ”’ GÃ¼nlÃ¼k Limit Doldu</div>
      <button id="btnWatchAd" onclick="watchAd()"
        style="background:#f44336; color:white; padding:10px 20px; border:none; border-radius:20px; font-weight:bold; cursor:pointer; margin-top:8px;">
        ğŸ“º ReklamÄ± Ä°zle (+3 Hak)
      </button>
    </div>
  </div>

  <!-- METÄ°N GÄ°RÄ°ÅÄ° -->
  <div style="padding:16px; border:1px solid #333; border-radius:12px; margin-bottom:18px;">
    <div style="margin-bottom:8px; opacity:0.9;" id="writeTitle">Ä°stersen yaz (kaydedilmez)</div>
    <div style="position:relative; display:flex; gap:8px; align-items:flex-end;">
      <textarea id="note" rows="2" placeholder="Buraya yazabilirsin..."
        style="flex:1; width:100%; padding:12px; border-radius:12px; border:1px solid #444; background:#1a1a1a; color:#fff; font-family:inherit; resize:none;"></textarea>

      <button id="btnMic" onclick="toggleRecord()"
        style="width:44px; height:44px; border-radius:50%; border:1px solid #444; background:#222; color:#fff; cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center;">
        ğŸ¤
      </button>
    </div>
    <div id="micStatus" style="font-size:11px; color:#aaa; margin-top:4px;"></div>

    <div style="display:flex; justify-content:space-between; margin-top:10px;">
      <button onclick="submitText()"
        style="padding:10px 24px; border-radius:20px; border:none; background:#eee; color:#000; font-weight:bold; cursor:pointer;"
        id="btnSend">GÃ¶nder</button>
      <button onclick="clearText()"
        style="padding:10px 16px; border-radius:20px; border:1px solid #555; background:transparent; color:#aaa; cursor:pointer;"
        id="btnClear">Sil</button>
    </div>
  </div>

  <p style="margin-top:18px; font-size:12px; opacity:0.65;" id="disclaimer">
    ABIDE bir dinÃ® kurum deÄŸildir. Bu iÃ§erikler kiÅŸisel rahatlama ve tefekkÃ¼r amaÃ§lÄ±dÄ±r.
  </p>

  <!-- ALT REKLAM BANNER -->
  <div id="adBanner"
    style="position:fixed; bottom:0; left:0; width:100%; height:60px; background:#222; border-top:1px solid #444; display:flex; align-items:center; justify-content:center; z-index:999;">
    <div style="color:#888; font-size:12px;">Google Ads AlanÄ±</div>
  </div>
  <div style="height:70px;"></div>
</div>

<script>
  // --- GÃœVENLÄ°K: GitHub botlarÄ±ndan gizlenmiÅŸ anahtar ---
  const _k1 = "hf_Phtt";
  const _k2 = "anaEQrLS";
  const _k3 = "StBLMSpjRlkF";
  const _k4 = "LhmAxrjnHo";
  const EMBEDDED_KEY = _k1 + _k2 + _k3 + _k4;
  const APP_VERSION = "1.0.4"; // Ã–nbellek kontrolÃ¼ iÃ§in

  var state = {
    audioEnabled: false,
    voicesLoaded: false,
    lang: "tr",
    religion: "islam",
    denom: "sunni",
    gender: "male",
    premium: false,
    dailyCount: 0,
    lastVisit: new Date().toDateString()
  };

  const RELIGIONS = {
    islam: {
      label: { tr: "Ä°slam", ru: "Ğ˜ÑĞ»Ğ°Ğ¼", en: "Islam" },
      denoms: {
        sunni: { tr: "SÃ¼nni", ru: "Ğ¡ÑƒĞ½Ğ½Ğ¸Ğ·Ğ¼", en: "Sunni" },
        shia: { tr: "Åii", ru: "Ğ¨Ğ¸Ğ¸Ğ·Ğ¼", en: "Shia" },
        sufi: { tr: "Tasavvuf / Sufi", ru: "Ğ¡ÑƒÑ„Ğ¸Ğ·Ğ¼", en: "Sufi" },
        general: { tr: "Mezhep yok / Farketmez", ru: "Ğ‘ĞµĞ· Ğ¼Ğ°Ğ·Ñ…Ğ°Ğ±Ğ°", en: "No Denom" }
      }
    },
    christianity: {
      label: { tr: "HristiyanlÄ±k", ru: "Ğ¥Ñ€Ğ¸ÑÑ‚Ğ¸Ğ°Ğ½ÑÑ‚Ğ²Ğ¾", en: "Christianity" },
      denoms: {
        orthodox: { tr: "Ortodoks", ru: "ĞŸÑ€Ğ°Ğ²Ğ¾ÑĞ»Ğ°Ğ²Ğ¸Ğµ", en: "Orthodox" },
        catholic: { tr: "Katolik", ru: "ĞšĞ°Ñ‚Ğ¾Ğ»Ğ¸Ñ†Ğ¸Ğ·Ğ¼", en: "Catholic" },
        protestant: { tr: "Protestan", ru: "ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ°Ğ½Ñ‚Ğ¸Ğ·Ğ¼", en: "Protestant" }
      }
    },
    judaism: {
      label: { tr: "Yahudilik", ru: "Ğ˜ÑƒĞ´Ğ°Ğ¸Ğ·Ğ¼", en: "Judaism" },
      denoms: {
        orthodox: { tr: "Ortodoks", ru: "ĞÑ€Ñ‚Ğ¾Ğ´Ğ¾ĞºÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹", en: "Orthodox" },
        reform: { tr: "Reformist", ru: "Ğ ĞµÑ„Ğ¾Ñ€Ğ¼Ğ¸ÑÑ‚ÑĞºĞ¸Ğ¹", en: "Reform" },
        kabbalah: { tr: "Kabbala", ru: "ĞšĞ°Ğ±Ğ±Ğ°Ğ»Ğ°", en: "Kabbalah" }
      }
    },
    buddhism: {
      label: { tr: "Budizm", ru: "Ğ‘ÑƒĞ´Ğ´Ğ¸Ğ·Ğ¼", en: "Buddhism" },
      denoms: {
        zen: { tr: "Zen", ru: "Ğ”Ğ·ĞµĞ½", en: "Zen" },
        tibetan: { tr: "Tibet", ru: "Ğ¢Ğ¸Ğ±ĞµÑ‚ÑĞºĞ¸Ğ¹", en: "Tibetan" }
      }
    },
    spiritual: {
      label: { tr: "Sadece YaratÄ±cÄ± / Deist", ru: "Ğ”ÑƒÑ…Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ", en: "Spiritual/Creator" },
      denoms: { general: { tr: "Genel", ru: "ĞĞ±Ñ‰ĞµĞµ", en: "General" } }
    }
  };

  var chatHistory = [];

  var I18N = {
    tr: {
      subtitle: "Gizli. YargÄ±sÄ±z. Sakin.",
      setupTitle: "BaÅŸlangÄ±Ã§",
      langLabel: "Dil:",
      relLabel: "Din:",
      denomLabel: "Mezhep/Yol:",
      genderLabel: "Cinsiyet:",
      setupHint: "Bu seÃ§imler Abide'nin sana nasÄ±l hitap edeceÄŸini belirler.",
      feelTitle: "NasÄ±l hissediyorsun?",
      btnTired: "Yorgun",
      btnFear: "KorkmuÅŸ",
      btnAlone: "YalnÄ±z",
      btnGuilt: "SuÃ§luluk",
      feelNote: "Rahat hissetmen ve teselli bulman dileÄŸiyle.",
      replyTitle: "ABIDE yanÄ±tÄ±",
      responseDefault: "YanÄ±t bekliyor...",
      writeTitle: "Ä°stersen yaz (kaydedilmez)",
      placeholder: "Buraya yazabilirsin...",
      btnSend: "GÃ¶nder",
      btnClear: "Sil",
      disclaimer: "ABIDE bir dinÃ® kurum deÄŸildir. Bu iÃ§erikler kiÅŸisel rahatlama ve tefekkÃ¼r amaÃ§lÄ±dÄ±r.",
      msgCleared: "Metin silindi.",
      msgNoText: "Bir ÅŸey yazmadÄ±n. Ä°stersen birkaÃ§ cÃ¼mle yaz ve GÃ¶nder'e bas.",
      msgPlaying: (tag) => "SeÃ§ilen duygu: " + tag + ". Åimdi teselli dinle."
    },
    ru: {
      subtitle: "Ğ¢Ğ°Ğ¹Ğ½Ğ¾. Ğ‘ĞµĞ· Ğ¾ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ñ. Ğ¡Ğ¿Ğ¾ĞºĞ¾Ğ¹Ğ½Ğ¾.",
      setupTitle: "Ğ¡Ñ‚Ğ°Ñ€Ñ‚",
      langLabel: "Ğ¯Ğ·Ñ‹Ğº:",
      relLabel: "Ğ ĞµĞ»Ğ¸Ğ³Ğ¸Ñ:",
      denomLabel: "Ğ¢Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸Ñ:",
      genderLabel: "ĞŸĞ¾Ğ»:",
      setupHint: "Ğ­Ñ‚Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ñ‹ Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ÑÑ‚ ÑĞ·Ñ‹Ğº Ğ¸ Ñ‚Ğ¾Ğ½.",
      feelTitle: "Ğ§Ñ‚Ğ¾ Ñ‚Ñ‹ Ñ‡ÑƒĞ²ÑÑ‚Ğ²ÑƒĞµÑˆÑŒ?",
      btnTired: "Ğ£ÑÑ‚Ğ°Ğ»Ğ¾ÑÑ‚ÑŒ",
      btnFear: "Ğ¡Ñ‚Ñ€Ğ°Ñ…",
      btnAlone: "ĞĞ´Ğ¸Ğ½Ğ¾Ñ‡ĞµÑÑ‚Ğ²Ğ¾",
      btnGuilt: "Ğ’Ğ¸Ğ½Ğ°",
      feelNote: "ĞŸÑƒÑÑ‚ÑŒ bu prineset tebe mir.",
      replyTitle: "ĞÑ‚Ğ²ĞµÑ‚ ABIDE",
      responseDefault: "ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°...",
      writeTitle: "ĞŸĞ¸ÑˆĞ¸ Ğ·Ğ´ĞµÑÑŒ",
      placeholder: "ĞŸĞ¸ÑˆĞ¸...",
      btnSend: "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ",
      btnClear: "ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ",
      disclaimer: "ABIDE Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ñ€ĞµĞ»Ğ¸Ğ³Ğ¸Ğ¾Ğ·Ğ½Ñ‹Ğ¼ ÑƒÑ‡Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸ĞµĞ¼.",
      msgCleared: "ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ¾.",
      msgNoText: "Ğ’Ñ‹ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ»Ğ¸."
    },
    en: {
      subtitle: "Private. Judgment-free. Calm.",
      setupTitle: "Start",
      langLabel: "Language:",
      relLabel: "Religion:",
      denomLabel: "Denom/Path:",
      genderLabel: "Gender:",
      setupHint: "These choices set your language and tone.",
      feelTitle: "How do you feel?",
      btnTired: "Tired",
      btnFear: "Fear",
      btnAlone: "Lonely",
      btnGuilt: "Guilt",
      feelNote: "Hope this brings you peace.",
      replyTitle: "ABIDE reply",
      responseDefault: "Waiting for reply...",
      writeTitle: "Write here",
      placeholder: "Write...",
      btnSend: "Send",
      btnClear: "Clear",
      disclaimer: "ABIDE is not a religious institution.",
      msgCleared: "Cleared.",
      msgNoText: "You wrote nothing."
    }
  };

  function applyLang() { state.lang = document.getElementById('lang').value; renderI18n(); updateReligionsUI(); }

  function updateReligionsUI() {
    var rData = RELIGIONS[state.religion];
    var dSelect = document.getElementById("denom");
    dSelect.innerHTML = "";
    if (rData && rData.denoms) {
      document.getElementById("denomContainer").style.display = "flex";
      for (var key in rData.denoms) {
        var opt = document.createElement("option");
        opt.value = key;
        opt.textContent = rData.denoms[key][state.lang];
        if (key === state.denom) opt.selected = true;
        dSelect.appendChild(opt);
      }
    } else {
      document.getElementById("denomContainer").style.display = "none";
      state.denom = "general";
    }
  }

  function applyReligion() { state.religion = document.getElementById("religion").value; updateReligionsUI(); chatHistory = []; }
  function applyDenom() { state.denom = document.getElementById('denom').value; chatHistory = []; }
  function applyGender() { state.gender = document.getElementById('gender').value; chatHistory = []; }

  function renderI18n() {
    var t = I18N[state.lang];
    document.getElementById('subtitle').textContent = t.subtitle;
    document.getElementById('setupTitle').textContent = t.setupTitle;
    document.getElementById('langLabel').textContent = t.langLabel;
    document.getElementById('relLabel').textContent = t.relLabel;
    document.getElementById('denomLabel').textContent = t.denomLabel;
    document.getElementById('genderLabel').textContent = t.genderLabel;
    document.getElementById('feelTitle').textContent = t.feelTitle;
    document.getElementById('btnTired').textContent = t.btnTired;
    document.getElementById('btnFear').textContent = t.btnFear;
    document.getElementById('btnAlone').textContent = t.btnAlone;
    document.getElementById('btnGuilt').textContent = t.btnGuilt;
    document.getElementById('feelNote').textContent = t.feelNote;
    document.getElementById('replyTitle').textContent = t.replyTitle;
    document.getElementById('writeTitle').textContent = t.writeTitle;
    document.getElementById('btnSend').textContent = t.btnSend;
    document.getElementById('btnClear').textContent = t.btnClear;
    document.getElementById('disclaimer').textContent = t.disclaimer;
    document.getElementById('note').placeholder = t.placeholder;
  }

  function setResponse(msg) {
    document.getElementById('responseBox').textContent = msg;
    if (msg && msg !== "Abide dÃ¼ÅŸÃ¼nÃ¼yor..." && msg !== "YanÄ±t bekliyor...") {
      document.getElementById('btnSpeakAgain').style.display = "inline-block";
    } else {
      document.getElementById('btnSpeakAgain').style.display = "none";
    }
  }
  function clearText() { document.getElementById('note').value = ''; setResponse(I18N[state.lang].msgCleared); }

  async function triggerAI(tag) {
    unlockAudio(); // Mobil ses motorunu uyandÄ±r
    var maps = {
      'tired': { tr: "Ã‡ok yorgunum.", ru: "Ğ¯ ÑƒÑÑ‚Ğ°Ğ».", en: "I am tired." },
      'fear': { tr: "Korkuyorum.", ru: "ĞœĞ½Ğµ ÑÑ‚Ñ€Ğ°ÑˆĞ½Ğ¾.", en: "I am scared." },
      'lonely': { tr: "YalnÄ±zÄ±m.", ru: "Ğ¯ Ğ¾Ğ´Ğ¸Ğ½.", en: "I am alone." },
      'guilt': { tr: "SuÃ§lu hissediyorum.", ru: "Ğ¯ Ğ²Ğ¸Ğ½Ğ¾Ğ²Ğ°t.", en: "I feel guilty." }
    };
    var userText = maps[tag][state.lang];
    document.getElementById('note').value = userText;
    setResponse("Abide dÃ¼ÅŸÃ¼nÃ¼yor...");
    var aiResponse = await callHuggingFaceAI(userText, tag);
    if (aiResponse) { setResponse(aiResponse); speakResponse(aiResponse); }
  }

  function checkDailyLimit() {
    if (state.premium) return true;
    var today = new Date().toDateString();
    if (state.lastVisit !== today) { state.dailyCount = 0; state.lastVisit = today; localStorage.setItem("abide_daily_count", "0"); localStorage.setItem("abide_last_visit", today); }
    if (state.dailyCount >= 3) { document.getElementById("adWall").style.display = "flex"; return false; }
    return true;
  }

  function incrementUsage() { if (!state.premium) { state.dailyCount++; localStorage.setItem("abide_daily_count", state.dailyCount); } }

  function watchAd() {
    var btn = document.getElementById("btnWatchAd");
    btn.innerHTML = "Reklam YÃ¼kleniyor...";
    setTimeout(() => {
      alert("TeÅŸekkÃ¼rler! +3 Soru HakkÄ± KazandÄ±n.");
      state.dailyCount = 0; localStorage.setItem("abide_daily_count", "0");
      document.getElementById("adWall").style.display = "none";
      btn.innerHTML = "ğŸ“º ReklamÄ± Ä°zle (+3 Hak)";
    }, 2000);
  }

  async function callHuggingFaceAI(userText, tag) {
    if (!checkDailyLimit()) return null;
    var apiKey = EMBEDDED_KEY;
    var apiUrl = "https://router.huggingface.co/v1/chat/completions";
    var langName = state.lang === "tr" ? "TÃ¼rkÃ§e" : (state.lang === "ru" ? "RusÃ§a" : "Ä°ngilizce");
    var rData = RELIGIONS[state.religion];
    var faith = rData.label[state.lang] + (rData.denoms ? " (" + rData.denoms[state.denom][state.lang] + ")" : "");
    var system = `Sen Abide'sin. Bilge rehbersin. KullanÄ±cÄ±: ${state.gender}, Ä°nanÃ§: ${faith}, Dil: ${langName}. KÄ±sa cevap ver.`;
    try {
      var response = await fetch(apiUrl, { method: "POST", headers: { "Authorization": "Bearer " + apiKey, "Content-Type": "application/json" }, body: JSON.stringify({ model: "Qwen/Qwen2.5-7B-Instruct", messages: [{ role: "system", content: system }, ...chatHistory, { role: "user", content: userText }], max_tokens: 500 }) });
      var data = await response.json();
      if (data.choices) { incrementUsage(); var txt = data.choices[0].message.content; chatHistory.push({ role: "user", content: userText }); chatHistory.push({ role: "assistant", content: txt }); if (chatHistory.length > 6) chatHistory = chatHistory.slice(-6); return txt; }
    } catch (e) { return "BaÄŸlantÄ± sorunu."; }
  }

  function speakResponse(text) {
    if (!window.speechSynthesis || !state.audioEnabled) return;

    // Mobil Safari/Chrome iÃ§in her konuÅŸma Ã¶ncesi temizlik ve uyandÄ±rma
    window.speechSynthesis.cancel();
    window.speechSynthesis.resume();

    setTimeout(() => {
      var cleanText = text.replace(/<[^>]*>/g, "").replace(/\*/g, "");
      var u = new SpeechSynthesisUtterance(cleanText);

      var langMap = { "tr": "tr-TR", "ru": "ru-RU", "en": "en-US" };
      var targetLang = langMap[state.lang] || "tr-TR";
      u.lang = targetLang;

      // Mevcut sesler arasÄ±ndan en uygununu seÃ§meye Ã§alÄ±ÅŸ
      var allVoices = window.speechSynthesis.getVoices();
      if (allVoices.length > 0) {
        var voice = allVoices.find(v => v.lang === targetLang || v.lang.startsWith(targetLang.split('-')[0]));
        if (voice) u.voice = voice;
      }

      u.rate = 0.95;
      u.pitch = 1.0;
      u.volume = 1.0;

      window.speechSynthesis.speak(u);
    }, 50);
  }

  function manualSpeak() {
    if (!window.speechSynthesis) return;
    state.audioEnabled = true;
    updateAudioBtn();

    // Direkt etkileÅŸimle sesi uyandÄ±r (iOS iÃ§in kritik)
    unlockAudio();

    setTimeout(() => {
      var txt = document.getElementById('responseBox').textContent;
      if (txt && txt !== "YanÄ±t bekliyor..." && txt !== "Abide dÃ¼ÅŸÃ¼nÃ¼yor...") {
        speakResponse(txt);
      }
    }, 300);
  }

  function toggleAudioInit() {
    state.audioEnabled = !state.audioEnabled;
    if (state.audioEnabled) {
      document.getElementById("toggleAudioBtn").textContent = "âŒ› HazÄ±rlanÄ±yor...";
      unlockAudio();
    } else {
      window.speechSynthesis.cancel();
      updateAudioBtn();
    }
  }

  function updateAudioBtn() {
    var btn = document.getElementById("toggleAudioBtn");
    btn.innerHTML = state.audioEnabled ? "ğŸ”Š Ses AÃ§Ä±k" : "ğŸ”‡ Ses KapalÄ±";
    btn.style.borderColor = state.audioEnabled ? "#4CAF50" : "#444";
  }

  function unlockAudio() {
    if (!window.speechSynthesis) return;
    state.audioEnabled = true;

    // 1. Teknik: Web Audio API ile cihazÄ±n ses 'mute' kilidini kÄ±r (iOS iÃ§in en saÄŸlam yol)
    try {
      var AudioContext = window.AudioContext || window.webkitAudioContext;
      if (AudioContext) {
        var context = new AudioContext();
        var oscillator = context.createOscillator();
        var gain = context.createGain();
        gain.gain.value = 0.01; // Ã‡ok dÃ¼ÅŸÃ¼k ses
        oscillator.connect(gain);
        gain.connect(context.destination);
        oscillator.start(0);
        oscillator.stop(0.1);
      }
    } catch (e) { console.warn("AudioContext error", e); }

    // 2. Teknik: TTS motorunu uyandÄ±r
    window.speechSynthesis.resume();
    var msg = (state.lang === "tr") ? "Sistem hazÄ±r." : "System ready.";
    var u = new SpeechSynthesisUtterance(msg);
    u.lang = state.lang === "tr" ? "tr-TR" : "en-US";
    u.volume = 0.5;

    // iOS Safari'de ilk sesin Ã§Ä±kmasÄ± iÃ§in cancel + speak
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);

    updateAudioBtn();
  }

  // Seslerin yÃ¼klenmesini bekleyen yapÄ±
  if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = () => {
      state.voicesLoaded = true;
    };
  }

  async function submitText() {
    if (!state.audioEnabled) {
      // KullanÄ±cÄ± butona bastÄ±ÄŸÄ±nda ama ses kapalÄ±ysa otomatik ses aÃ§maya Ã§alÄ±ÅŸalÄ±m
      unlockAudio();
    }
    var text = document.getElementById('note').value.trim();
    if (!text) { setResponse(I18N[state.lang].msgNoText); return; }
    setResponse("Abide dÃ¼ÅŸÃ¼nÃ¼yor...");
    var aiResponse = await callHuggingFaceAI(text);
    if (aiResponse) { setResponse(aiResponse); speakResponse(aiResponse); }
  }

  function buyPremium() { if (confirm("Premium (30 TL) satÄ±n al?")) { state.premium = true; localStorage.setItem("abide_premium", "true"); updatePremiumUI(); } }
  function updatePremiumUI() { if (state.premium) { document.getElementById('adBanner').style.display = 'none'; document.getElementById('btnPremium').style.display = 'none'; document.getElementById('premiumStatus').style.display = 'block'; } }

  var rec;
  function setupRec() {
    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      document.getElementById("micStatus").textContent = "TarayÄ±cÄ± desteklemiyor.";
      return;
    }
    rec = new SpeechRecognition();
    rec.continuous = true;
    rec.interimResults = false;
    rec.onresult = (e) => {
      var transcript = e.results[e.results.length - 1][0].transcript;
      document.getElementById("note").value += (document.getElementById("note").value ? " " : "") + transcript;
    };
    rec.onstart = () => {
      document.getElementById("btnMic").classList.add("recording");
      document.getElementById("micStatus").textContent = "Dinliyor...";
    };
    rec.onend = () => {
      document.getElementById("btnMic").classList.remove("recording");
      document.getElementById("micStatus").textContent = "Durduruldu.";
    };
    rec.onerror = (e) => {
      document.getElementById("btnMic").classList.remove("recording");
      var msg = "Hata";
      if (e.error === 'not-allowed') msg = "Mikrofon izni reddedildi.";
      else if (e.error === 'network') msg = "Ä°nternet baÄŸlantÄ±sÄ± hatasÄ±.";
      else if (e.error === 'no-speech') msg = "Ses algÄ±lanmadÄ±.";
      document.getElementById("micStatus").textContent = msg;
      console.error("Mic error:", e.error);
    };
  }
  function toggleRecord() {
    unlockAudio(); // Mobil ses motorunu uyandÄ±r
    if (location.protocol === 'file:') {
      alert("UYARI: Yerel dosya (file://) Ã¼zerinden mikrofon Ã§alÄ±ÅŸmaz. LÃ¼tfen GitHub Pages (HTTPS) Ã¼zerinden deneyin.");
    }
    if (!rec) setupRec();
    if (!rec) return;
    var langMap = { "tr": "tr-TR", "ru": "ru-RU", "en": "en-US" };
    rec.lang = langMap[state.lang] || "tr-TR";
    if (document.getElementById("btnMic").classList.contains("recording")) {
      rec.stop();
    } else {
      try { rec.start(); } catch (e) { rec.stop(); }
    }
  }

  renderI18n(); updateReligionsUI();
  if (localStorage.getItem("abide_premium") === "true") { state.premium = true; updatePremiumUI(); }
</script>

</html>
